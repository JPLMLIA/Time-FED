# Forecasting

The primary script for forecasting is `forecast.py`. This script handles taking prepared data, adding new features to it, creating windows and extracting even more features, optimizing which models to use for forecasting, and then performing the forecasts.

## Installation and Setup

To install MLOC, pull the repository, `cd` into it, and `pip install .`. This will install the project into the currently active python environment. An `environment.yml` file is provided to create a virtual environment with via Conda if that is preferred.

To install with Conda, follow:
1. Install Conda [here](https://docs.conda.io/projects/conda/en/latest/user-guide/install/)
2. Install the MLOC environment via `conda create env -f environment.yml`
- Windows may use different syntax, such as `conda env create` within the directory containing the `environment.yml` file
3. Invoke the environment via `conda activate mloc`
4. Install MLOC via `pip install /path/to/mloc/`

The folder structure for the forecasting script is expected to be in this format:

```
deployment/
|[case]/
||_data/
||features/
||models/
||forecasts/
```

This deployment directory may be set via the environment variable `MLOC_DEPLOYDIR`. Alternatively, this path can be set via `-d, --deploydir` at runtime. If this path is not specified, the script will exit early.

Each forecasting case (ie. a variable to forecast) needs its own directory with the four subdirectories in it.
* `_data/` is used by `forecast.py` to store intermediary products such as the windows produced. This will be generated by the script if it is not present.
* `features/` contains the pickle files of feature lists for each run of the given case, as well as an `all_features.pkl`. Must be manually created.
* `models/` contains the forecasting models. Must be manually created.
* `forecasts/` contains the output forecasts. This will be generated by the script if it is not present.

## Interface

The below table provides a list of the arguments currently supported by `forecast.py`. For more information please see `python forecast.py --help`.

| Short Arg | Long Arg | Description | Default | Example
|-|-|-|-|-
|case||Positional argument that is required which defines the case for the run||`forecast.py r0`, `forecast.py pwv`
|-i|--input|Path to the input data file||`-i /data/mloc/r0/data.csv`
|-d|--deploydir|Path to the deployment directory|Environment variable `MLOC_DEPLOYDIR`| `-d /proj/mloc/mloc/forecasting/deployment`
|-k|--key|The key to the Pandas DataFrame object if the --input is an H5 file|`test`|`-k data`
|-f|--forecasts|How far into the future to forecast. This value should be N * cadence <= [r0,weather=180\|pwv=300]|Defaults to 3 hours in any case|`-f 36`, `-f 18`, `-f 2`
|-c|--cadence|The forecasting cadence, ie. how often to forecast. Must be a multiple of the resolution of the input data, eg. r0/weather is a multiple of 5, PWV a multiple of 30|Defaults to the resolution of the input data|`-c 5`, `-c 30`, `-c 60`
|-o|--optimize|Optimizes forecasting by selecting the best model for a given forecast. Not optimizing will use all models available to forecast.|False|`-o`, `--optimize`
|-p|--preview|Previews the arguments of the scripts before execution. Useful to ensure arguments are set correctly before committing to execution.|False|`-p`, `--preview`
||--skip_check|Skips the check for the last window processed on this input data. May reprocess already processed timestamps.|False|`--skip_check`
||--debug|Enables debug logging|False|`--debug`



### Input

The input to forecast.py must be in a format readable by the Pandas Python package. Currently two formats are supported:

* A CSV file
* A Pandas object stored in an H5 file

In either case, the data is assumed to have a consistent resolution. In other words, if a forecast variable samples at a rate of every 5 minutes, the input data is assumed to have a resolution of 5 minutes. That is, the distance between any two data points is a multiple of its resolution.

#### CSV Examples

Below are a few examples of correct CSV formats.

| datetime | var1 | var2
|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | a1 | b1
| 1996-11-04 22:35:00 | a2 | b2
| 1996-11-04 22:40:00 | a3 | b3
| 1996-11-04 22:45:00 | a4 | b4
| 1996-11-04 22:50:00 | a5 | b5
| ... | ... | ...

Notice that the distance between the timestamps is 5 minutes. That implies the resolution of the data is 5 minutes. This must be maintained and consistent throughout the entire data. Missing timestamps is permitted, but the consistent resolution is mandatory. An example of an inconsistent resolution is:

| datetime | var1 | var2
|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | a1 | b1
| 1996-11-04 22:33:00 | a2 | b2
| 1996-11-04 22:37:00 | a3 | b3
| 1996-11-04 22:45:00 | a4 | b4
| 1996-11-04 22:50:00 | a5 | b5
| ... | ... | ...

These timestamps have inconsistent resolution. The script will fail to notice this inconsistency, and the performance of the script cannot be guaranteed if this occurs.

#### MLOC Examples

These examples are specific to the MLOC project, but provide a real use-case scenario.

##### r0

A typical r0 input would look like this:

| datetime | temperature | pressure | relative_humidity | wind_speed | Cn2_10T | r0_10T
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | 70 | 40 | 83.4 | 23 | 1.08e7 | 6.07
| 1996-11-04 22:35:00 | 70 | 40 | 82.6 | 24 | 1.08e7 | NaN
| 1996-11-04 22:40:00 | 71 | 40 | 87.1 | 24 | NaN | 5.23
| 1996-11-04 22:45:00 | 71 | 40 | 85.0 | 25 | NaN | 4.37
| 1996-11-04 22:50:00 | 72 | 40 | 83.8 | 26 | NaN | NaN

* !Important: r0 and Cn2 must be smoothed using a 10 minute rolling window. That is, these variables would have each value at timestamp T replaced with the average(T-1, T, T+1)
* The nowcast is the last timestamp in the table. Therefore, no r0 value would be recorded at this time.

To convert this into a CSV file:
```
datetime,temperature,pressure,relative_humidity,wind_speed,Cn2_10T,r0_10T
1996-11-04 22:30:00,70,40,83.4,23,1.08e7,6.07
1996-11-04 22:35:00,70,40,82.6,24,1.08e7,NaN
1996-11-04 22:40:00,71,40,87.1,24,NaN,5.23
1996-11-04 22:45:00,71,40,85.0,25,NaN,4.37
1996-11-04 22:50:00,72,40,83.8,26,NaN,NaN
```

Appending to this data file will not impact the forecasting script. The script is designed to notice if data has already been processed or not, and will only process new data.

##### PWV

TODO

##### Weather

Weather looks the exact same as the r0 input but does not include Cn2 or r0. It is expected to have a resolution of 5 minutes.
