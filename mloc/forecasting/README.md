# Forecasting

The primary script for forecasting is `forecast.py`. This script handles taking prepared data, adding new features to it, creating windows and extracting even more features, selecting which models to use for forecasting, and then performing the forecasts.

## Installation and Setup

To install MLOC, pull the repository, `cd` into it, and `pip install .`. This will install the project into the currently active python environment. An `environment.yml` file is provided to create a virtual environment with via Conda if that is preferred.

To install with Conda, follow:
1. Install Conda [here](https://docs.conda.io/projects/conda/en/latest/user-guide/install/)
2. Install the MLOC environment via `conda create env -f environment.yml`
- Windows may use different syntax, such as `conda env create` within the directory containing the `environment.yml` file
3. Invoke the environment via `conda activate mloc`
4. Change directories into the repository where `setup.py` is found
5. Install MLOC via `pip install .`
- Windows may raise an error: `ERROR: Could not install packages due to an EnvironmentError`. To get around this, append `--user` to the above command.

## Use Cases

forecast.py was developed with the following use cases (refered to in this README simply as **case**):

| Case | Description 
|-|-
|r0.weather| r0 forecasting using weather inputs only
|r0.weather.historical| r0 forecastingusing weather and past r0 observations 
|r0.cn2.weather| r0 forecastingusing weather plus Cn2
|r0.cn2.weather.historical| r0 forecasting using weather and past r0 observations
|temperature| 
|pressure|
|relative_humidity|
|wind_speed|
|pwv| precipitable water vapor


## Directory Structure



The directory structure for the forecasting script is expected to be in this format:

```
deployment/
deployment/[case]/
deployment/[case]/_data/
deployment/[case]/features/
deployment/[case]/models/
deployment/[case]/forecasts/
```

This deployment directory may be set via the environment variable `MLOC_DEPLOYDIR`. Alternatively, this path can be set via `-d, --deploydir` at runtime. If this path is not specified, the script will exit early.

Each forecasting case (ie. a variable to forecast) needs its own directory with the four subdirectories in it.
* `_data/` is used by `forecast.py` to store intermediary products such as the windows produced. This will be generated by the script if it is not present.
* `features/` contains the pickle files of feature lists for each run of the given case, as well as an `all_features.pkl`. Must be manually created.
* `models/` contains the forecasting models. Must be manually created.
* `forecasts/` contains the output forecasts. This will be generated by the script if it is not present.

## Interface

The below table provides a list of the arguments currently supported by `forecast.py`. For more information please see `python forecast.py --help`.

| Short Arg | Long Arg | Description | Default | Example
|-|-|-|-|-
|case||Positional argument that is required which defines the case for the run||`forecast.py r0`, `forecast.py pwv`
|-i|--input|Path to the input data file||`-i /data/mloc/r0/data.csv`
|-d|--deploydir|Path to the deployment directory|Environment variable `MLOC_DEPLOYDIR`| `-d /proj/mloc/mloc/forecasting/deployment`
|-k|--key|The key to the Pandas DataFrame object if the --input is an H5 file|`test`|`-k data`
|-f|--forecasts|* How far into the future to forecast. This value should be N * cadence <= [r0,weather=180\|pwv=300]|Defaults to 3 hours in any case|`-f 36`, `-f 18`, `-f 2`
|-c|--cadence|The forecasting cadence, ie. how often to forecast. Must be a multiple of the resolution of the input data, eg. r0/weather is a multiple of 5, PWV a multiple of 30|Defaults to the resolution of the input data|`-c 5`, `-c 30`, `-c 60`
|-s|--select|Smart selects forecasting models by using the best model for a given forecast. Disabling this option will use all models available to forecast. If this option is followed by a string, only that set of models will be used|False|`-s`, `--select`, `--select r0.Cn2.weather.historical`
|-p|--preview|Previews the arguments of the scripts before execution. Useful to ensure arguments are set correctly before committing to execution.|False|`-p`, `--preview`
||--skip_check|Skips the check for the last window processed on this input data. May reprocess already processed timestamps.|False|`--skip_check`
||--debug|Enables debug logging|False|`--debug`

The formula for calculating the `--forecasts F` value is:

`F * C = D (minutes)`

where
* `D` = The forecast distance, in minutes
* `F` = The forecast distance, in units of the resolution
* `C` = The cadence of the forecasting, which is a multiple of the resolution of the data

Solving for `F`, which is the value to plug in for `--forecasts` would be:

`F = D / C`

### Example Usages

> I want to forecast every 10 minutes up to 3 hours for data with a resolution of 5 minutes (r0, weather)

`python forecast.py r0 -i /path/to/input/data.csv --cadence 10 --forecasts 18`
* `r0` defines the case
* `-i` is the path to the input data.csv
* `--cadence 10` (can be reduced to `-c 10`) defines the frquency of the forecasts, in this case "every 10 minutes"
* `--forecasts 18` (can be reduced to `-f 18`) sets the forecasting limit to be `D / C` (see the Interface section for more). Since the forecast distance (`D`) is 180 minutes, the value (`F`) is `180 / 10 = 18`. This option does not need to be set if the intended forecast distance is 3 hours.
36/10/5

> I want to forecast every 30 minutes up to 2 hours for data with a resolution of 30 minutes (PWV)

`python forecast.py pwv -i /path/to/input/data.csv -c 30 -f 4`

* `-c 30` sets the cadence to 30 minutes, but the resolution of the data is already 30 so this option can be omitted (defaults to 30)
* `-f 4`, formula `120 / 10`

> I want to forecast r0 every 5 minutes up to 3 hours using all possible models

`python forecast.py r0 -i  /path/to/input/data.csv --select`

* `-f` was omitted as the target forecasting distance is 3 hours, which is the default
* `-c` was omitted as the desired cadence rate is the same as the resolution of the data, 5 minutes. Defaults to the resolution when not provided
* `--select` (optionally shortened to `-no`) disables optimization of model selection and will attempt to apply all models for forecasting, if possible

> I want to forecast r0 every 10 minutes up to 3 hours using only [SET] of models

The r0 case will attempt to smart select which models are used for forecasting by default. To disable this, use the `--select` option.

`python forecast.py r0 -i /path/to/input/data.csv -c 10 --select [SET]`

* `-f` was omitted as the target forecasting distance is 3 hours, which is the default
* `--select [SET]` this run will _only_ use the set of models from `[SET]` (eg. `r0.Cn2.weather.historical`) to forecast with, if possible.

Subexamples:

* `python forecast.py r0 -i /path/to/input/data.csv -c 10 --no r0.Cn2.weather.historical`
* `python forecast.py r0 -i /path/to/input/data.csv -c 10 --no r0.Cn2.weather`
* `python forecast.py r0 -i /path/to/input/data.csv -c 10 --no r0.weather.historical`
* `python forecast.py r0 -i /path/to/input/data.csv -c 10 --no r0.weather`

NOTE: Models will not be invoked if the data is not viable for the models, ie. there is missing data that the stricter sets of models (`Cn2`, `historical` models) require. If this occurs, the script may not output any forecasts (as there are none).


### Input

The input to forecast.py must be in a format readable by the Pandas Python package. Currently two formats are supported:

* A CSV file
* A Pandas object stored in an H5 file

In either case, the data is assumed to have a consistent resolution. In other words, if a forecast variable samples at a rate of every 5 minutes, the input data is assumed to have a resolution of 5 minutes. That is, the distance between any two data points is a multiple of its resolution.

#### CSV Examples

Below are a few examples of correct CSV formats.

| datetime | var1 | var2
|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | a1 | b1
| 1996-11-04 22:35:00 | a2 | b2
| 1996-11-04 22:40:00 | a3 | b3
| 1996-11-04 22:45:00 | a4 | b4
| 1996-11-04 22:50:00 | a5 | b5
| ... | ... | ...

Notice that the distance between the timestamps is 5 minutes. That implies the resolution of the data is 5 minutes. This must be maintained and consistent throughout the entire data. Missing timestamps is permitted, but the consistent resolution is mandatory. An example of an inconsistent resolution is:

| datetime | var1 | var2
|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | a1 | b1
| 1996-11-04 22:33:00 | a2 | b2
| 1996-11-04 22:37:00 | a3 | b3
| 1996-11-04 22:45:00 | a4 | b4
| 1996-11-04 22:50:00 | a5 | b5
| ... | ... | ...

These timestamps have inconsistent resolution. The script will fail to notice this inconsistency, and the performance of the script cannot be guaranteed if this occurs.

#### MLOC Examples

These examples are specific to the MLOC project, but provide a real use-case scenario.

##### r0

A typical r0 input would look like this:

| datetime | temperature | pressure | relative_humidity | wind_speed | Cn2_10T | r0_10T
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 1996-11-04 22:30:00 | 70 | 40 | 83.4 | 23 | 1.08e7 | 6.07
| 1996-11-04 22:35:00 | 70 | 40 | 82.6 | 24 | 1.08e7 | NaN
| 1996-11-04 22:40:00 | 71 | 40 | 87.1 | 24 | NaN | 5.23
| 1996-11-04 22:45:00 | 71 | 40 | 85.0 | 25 | NaN | 4.37
| 1996-11-04 22:50:00 | 72 | 40 | 83.8 | 26 | NaN | NaN

* !Important: r0 and Cn2 must be smoothed using a 10 minute rolling window. That is, these variables would have each value at timestamp T replaced with the average(T-1, T, T+1)
* The nowcast is the last timestamp in the table. Therefore, no r0 value would be recorded at this time.
* Variables `r0_10T` and `Cn2_10T` are not required

To convert this into a CSV file:
```
datetime,temperature,pressure,relative_humidity,wind_speed,Cn2_10T,r0_10T
1996-11-04 22:30:00,70,40,83.4,23,1.08e7,6.07
1996-11-04 22:35:00,70,40,82.6,24,1.08e7,NaN
1996-11-04 22:40:00,71,40,87.1,24,NaN,5.23
1996-11-04 22:45:00,71,40,85.0,25,NaN,4.37
1996-11-04 22:50:00,72,40,83.8,26,NaN,NaN
```

Appending to this data file will not impact the forecasting script. The script is designed to notice if data has already been processed or not, and will only process new data.

##### PWV

PWV expects a time resolution of 30 minutes and contains the following variables: `temperature`, `pressure`, `wind_speed`, `humidity`, `dewpoint`

##### Weather

Weather looks the exact same as the r0 input but does not include Cn2 or r0. It is expected to have a resolution of 5 minutes.

### Outputs

The script will output to `MLOC_DEPLOYDIR/[case]/forecasts/[run].csv`. If the `case` has multiple runs (eg. `r0.Cn2.weather.historical`, `r0.weather`), then multiple csv files will be present. The header of the file will always be `datetime,int,int,int,...`, where the `ints` are the forecasts, eg. `datetime,0,10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180`.

Example output for r0:

```
datetime,0,10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180
2020-12-30 00:45:00,6.166446180731198,6.214913086052983,5.841368201867026,6.51203835223976,6.525594391549899,6.416350970707881,6.379592944611676,7.268432919298063,6.29127912343241,6.898307691668561,6.87290048519368,6.10958255206236,5.701098580514675,5.57
6853170761268,5.9321206961965505,5.553276834911012,5.81514875,5.078259283778028,5.4632150077234805
2020-12-30 00:50:00,6.098215788730273,6.230448437035285,5.8320792093671905,6.158044838892881,6.222005306625386,6.232811770724945,6.070958364828856,7.119622146245678,6.367685623432409,6.786624288243919,6.790664485193681,6.080253597349098,5.656618003806245
,5.611362920761269,5.834306225404703,5.52028224013463,5.800730749999998,5.059120130725534,5.443479257723479
2020-12-30 00:55:00,6.055357720845418,6.173675966497019,5.937593101114508,6.3560063816891885,6.556972883884388,6.775515572435289,6.577872239695262,7.369630899749507,6.401329922932257,6.678885570520862,6.695923985193681,6.101445964911663,5.650830129670031
,5.559208920761268,5.8383779754047005,5.530880088065467,5.737051249999997,5.084414443110501,5.419204507723477
2020-12-30 01:00:00,6.115352622673028,6.03150666936433,5.960728586949812,6.2493860613702035,6.368289584415021,7.241098089670285,6.851729931328745,7.396375399749507,6.396823254867842,6.719291570520861,6.421469369178656,5.819935510198401,5.5740453796700296
,5.645335618056741,5.787269725404701,5.562297088065468,5.751357999999997,5.075069443110501,5.413686507723478
```

The above was generated from a run using `python forecast.py r0 -d deployment -i deployment\r0\_data\2.test.csv -c 10`

The cadence was set to `-c 10`, so the header of the csv increments by 10 minutes. If the run was using a 5 minute cadence, the header would be increments of 5 up to 180.

The datetime of the row is the t0 time for that forecast. The `0` column for that row would be the nowcast, and all other columns are for the forecast of `datetime` + `column` minutes.
